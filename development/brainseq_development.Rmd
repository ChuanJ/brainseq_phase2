---
title: "DLPFC brain development"
author: "Leo"
date: "11/17/2017"
output:
  html_document:
    code_folding: show
    toc: true
    toc_float: true
---


## Setup

```{r 'setup'}
library('SummarizedExperiment')
library('recount')
library('edge')
library('devtools')
library('ggplot2')
library('reshape2')

## Load gene data and keep controls only
load('../expr_cutoff/rse_gene.Rdata')
rse_gene <- rse_gene[, colData(rse_gene)$Dx == 'Control']

## Add mds info
load('../genotype_data/mds_extracted_from_BrainSeq_Phase2_RiboZero_Genotypes_n546.Rdata')
m <- match(colData(rse_gene)$BrNum, rownames(mds))

## Drop those that don't match
colData(rse_gene)$BrNum[which(is.na(m))]

rse_gene <- rse_gene[, !is.na(m)]
colData(rse_gene) <- cbind(colData(rse_gene), mds[m[!is.na(m)], ])
rm(m, mds)

## Set as factor
colData(rse_gene)$Region <- relevel(factor(colData(rse_gene)$Region), 'DLPFC')
colData(rse_gene)$Race <- relevel(factor(colData(rse_gene)$Race), ref = 'CAUC')
colData(rse_gene)$Sex <- relevel(factor(colData(rse_gene)$Sex), ref = 'F')

## Add age linear splines
fetal <- ifelse(colData(rse_gene)$Age < 0, 1,0)
birth <- colData(rse_gene)$Age
birth[birth < 0] <- 0 # linear spline
infant <- colData(rse_gene)$Age - 1
infant[infant < 0] <- 0 # linear spline
child <- colData(rse_gene)$Age - 10
child[child < 0] <- 0 # linear spline
teen <- colData(rse_gene)$Age - 20
teen[teen < 0] <- 0 # linear spline
adult <- colData(rse_gene)$Age - 50
adult[adult < 0] <- 0 # linear spline

colData(rse_gene)$fetal <- fetal
colData(rse_gene)$birth <- birth
colData(rse_gene)$infant <- infant
colData(rse_gene)$child <- child
colData(rse_gene)$teen <- teen
colData(rse_gene)$adult <- adult
rm(fetal, birth, infant, child, teen, adult)

## To simplify later code
pd <- as.data.frame(colData(rse_gene))
pd <- pd[, match(c('Age', 'fetal', 'birth', 'infant', 'child', 'teen', 'adult', 'Sex', 'snpPC1', 'snpPC2', 'snpPC3', 'snpPC4', 'snpPC5', 'Region', 'Race'), colnames(pd))]
rpkm <- assays(rse_gene)$rpkm
DLPFC <- colData(rse_gene)$Region == 'DLPFC'

## Define models
fm_mod <-  ~Age + fetal + birth + infant + child + teen + adult + Sex + snpPC1 + snpPC2 + snpPC3 + snpPC4 + snpPC5
fm_mod0 <- ~ Age + Sex + snpPC1 + snpPC2 + snpPC3 + snpPC4 + snpPC5
fm_mod_all <- ~Age *Region + fetal * Region + birth *Region + infant *Region + child * Region + teen * Region + adult * Region + Sex + Region + snpPC1 + snpPC2 + snpPC3 + snpPC4 + snpPC5
fm_mod0_all <- ~ Age + fetal + birth + infant + child + teen + adult + Sex + Region + snpPC1 + snpPC2 + snpPC3 + snpPC4 + snpPC5


get_mods <- function(pd, int = FALSE) {    
    ### adjust for race, sex
    if(int) {
        mod = model.matrix(fm_mod_all, data=pd)
        mod0 = model.matrix(fm_mod0_all, data=pd)
    } else {
        mod = model.matrix(fm_mod, data=pd)
        mod0 = model.matrix(fm_mod0, data=pd)
    }
    return(list(mod = mod, mod0 = mod0))
}
```

## DLPFC


```{r 'dlpfc'}
### DLPFC
de_obj_dlpfc <- build_models(data = rpkm[, DLPFC], full.model = fm_mod, null.model = fm_mod0, cov = pd[DLPFC, ])
ef_obj_dlpfc <- fit_models(de_obj_dlpfc, stat.type = "lrt")
de_lrt_dlpfc <- lrt(de_obj_dlpfc, nullDistn = "normal")

summary(de_lrt_dlpfc)
hist(qvalueObj(de_lrt_dlpfc))
summary(qvalueObj(de_lrt_dlpfc)$qvalues)
```


## HIPPO

```{r 'hippo'}
### HIPPO
de_obj_hippo <- build_models(data = rpkm[, !DLPFC], full.model = fm_mod, null.model = fm_mod0, cov = pd[!DLPFC, ])
ef_obj_hippo <- fit_models(de_obj_hippo, stat.type = "lrt")
de_lrt_hippo <- lrt(de_obj_hippo, nullDistn = "normal")

summary(de_lrt_hippo)
hist(qvalueObj(de_lrt_hippo))
summary(qvalueObj(de_lrt_hippo)$qvalues)
```


## Quick region comparison

```{r 'quick_comp'}
### Compare quickly
stopifnot(identical(rownames(de_obj_dlpfc), rownames(de_obj_hippo)))

comp <- data.frame(
    DLPFC = qvalueObj(de_lrt_dlpfc)$qvalues,
    HIPPO = qvalueObj(de_lrt_hippo)$qvalues,
    gene_id = rownames(de_obj_dlpfc),
    stringsAsFactors = FALSE
)
dim(comp)

## Using the LRT model results
table(comp$DLPFC < 1e-04, comp$HIPPO < 1e-04)

#save(comp, file = 'edge_comp.Rdata')
```


## Both regions

```{r 'interaction_mod'}
de_obj <- build_models(data = rpkm, full.model = fm_mod_all, null.model = fm_mod0_all, cov = pd)
system.time( ef_obj <- fit_models(de_obj, stat.type = "lrt") )
system.time( de_lrt <- lrt(de_obj, nullDistn = "normal") )

summary(de_lrt)
hist(qvalueObj(de_lrt))
summary(qvalueObj(de_lrt)$qvalues)
```


## Explore a gene

The following code explores a single gene based on the `de_lrt_dlpfc`, `de_odp_dlpfc`, `de_lrt_hippo`, `de_odp_hippo` and `de_lrt` results.

```{r 'explore_gene', fig.width = 14, fig.height = 7}

gene_explore <- function(ef, de, pd) {
    fitVals <- fitFull(ef)
    fitVals0 <- fitNull(ef)


    i <- which.min(qvalueObj(de)$qvalue)
    print(qvalueObj(de)$qvalue[i])

    df <- data.frame(age= pd$Age, sex= pd$Sex, race = pd$Race, region = pd$Region, null.model = fitVals0[i, ], full.model = fitVals[i, ], raw = exprs(de)[i, ])
    
    
    df <- melt(data = df, id.vars=c("age", "sex", 'race', 'region'))
    df$value <- log(df$value + 1)
    
    p1 <- ggplot(df, aes(log10(age + 1), value, color=sex, shape = race)) + geom_point() + facet_wrap(region~variable) + ylab('log(RPKM + 1)') + xlab('log10(age + 1)') + geom_vline(xintercept = log10(c(0, 1, 10, 20, 50) + 1))
    p2 <- ggplot(df, aes(age, value, color=sex, shape = race)) + geom_point() + facet_wrap(region~variable) + ylab('log(RPKM + 1)') + geom_vline(xintercept = c(0, 1, 10, 20, 50))
    return(list(p1, p2))
}

## DLPFC lrt
gene_explore(ef_obj_dlpfc, de_lrt_dlpfc, pd[DLPFC, ])

## HIPPO lrt
gene_explore(ef_obj_hippo, de_lrt_hippo, pd[!DLPFC, ])
```

```{r 'explore_gene_both', fig.width = 14, fig.height = 10}
## both
gene_explore(ef_obj, de_lrt, pd)
```

## Limma

This portion uses `limma` to fit the region by age interaction model and calculate a global F statistic.

```{r 'limma'}
### Both
mods <-  get_mods( colData(rse_gene), int = TRUE)
sapply(mods, colnames)

library('limma')
library('edgeR')
library('qvalue')

ind <- data.frame(
    brnum = colData(rse_gene)$BrNum,
    rnum = colData(rse_gene)$RNum,
    stringsAsFactors = FALSE
)

brnum <- ind$brnum[match(rownames(pd), ind$rnum)]

design <- mods$mod

dge <- DGEList(counts = assays(rse_gene)$counts)
dge <- calcNormFactors(dge)
v <- voom(dge, design, plot = TRUE)

## Page 49 (50 in the pdf) of limmaUsersGuide()
## Didn't run in my laptop (likely needs more mem)
if(FALSE) {
    corfit <- duplicateCorrelation(v$E, design, block=brnum)
    corfit$consensus
    fit <- lmFit(v, design, correlation = corfit$consensus)
} else {
    fit <- lmFit(v, design)
}

fit <- eBayes(fit)

colnames(design)[grep(':', colnames(design))]
top <- topTable(fit, coef = grep(':', colnames(design)), n = nrow(rse_gene))


qval <- qvalue(top$P.Value)
summary(qval)
hist(qval)
summary(qval$qvalues)
summary(top$adj.P.Val)

sapply(c(1e-04, 0.001, 0.01, 0.025, 0.05, 0.1, 1), function(x) { sum(top$adj.P.Val < x)})

# log2FC <- fit$coefficients[, 2]
# pvalue <- fit$p.value[, 2]
# qvalue <- qvalue(pvalue)$qvalues
```

## Reproducibility

```{r}
## Reproducibility information
print('Reproducibility information:')
Sys.time()
proc.time()
options(width = 120)
session_info()
```

